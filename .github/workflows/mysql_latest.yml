name: RAB_MySQL-latest

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        dotnet: ["3.1.102"]
    steps:
      - name: Shutdown Ubuntu MySQL (SUDO)
        run: sudo service mysql stop
      - name: Setup MySQL Service
        uses: mirromutth/mysql-action@v1.1
        with:
          host port: 3306
          container port: 3306
          mysql version: "latest"
          mysql root password: "root"
      - name: Checkout
        uses: actions/checkout@v1
      - name: Setup .NET Core ${{ matrix.dotnet }}
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: ${{ matrix.dotnet }}
      - name: Restore NuGet packages
        run: dotnet restore
      - name: Build
        run: dotnet build --configuration Release
      - name: Setup test database
        run: |
          sudo apt-get install -y mysql-client
          mysql -h 127.0.0.1 -P 3306 -uroot -proot -e "CREATE USER 'devel'@'%' IDENTIFIED BY 'devel'"
          mysql -h 127.0.0.1 -P 3306 -uroot -proot -e "GRANT ALL PRIVILEGES ON *.* TO 'devel'@'%'"
          mysql -h 127.0.0.1 -P 3306 -uroot -proot -e "FLUSH PRIVILEGES"
          mysql -h 127.0.0.1 -P 3306 -uroot -proot -e "CREATE DATABASE rab_t1"
      - name: Run tests
        run: dotnet test --verbosity normal
